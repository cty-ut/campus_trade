````markdown
# 🏫 校内二手交易平台 - 后端开发报告

**版本:** 2.0  
**状态:** ✅ 后端功能开发完成（含交易确认系统）  

---

## 1. 项目概述

本项目旨在开发一个专属于本校学生的 **C2C（二手交易）平台**。  
后端 API 的核心目标是提供一个 **安全、专属、功能完备** 的服务器端，支持前端（如 React）实现所有业务逻辑。

### 🎯 核心理念

- **安全 (Security):** 使用 JWT Token 进行状态管理，对敏感操作进行严格的认证与授权检查。  
- **专属 (Exclusive):** 通过强制的校内邮箱后缀验证，确保用户真实性。  
- **功能 (Functionality):** 覆盖注册、登录、发帖、传图、收藏、私信、举报等完整业务流程。

---

## 2. 技术栈 (Tech Stack)

| 类别 | 技术 | 用途 |
|------|------|------|
| Web 框架 | **FastAPI** | 构建高性能 Web API |
| 数据库 | **MySQL** | 存储所有核心数据 |
| ORM | **SQLAlchemy** | 实现数据库对象映射 |
| 数据验证 | **Pydantic** | 定义和验证请求/响应数据 |
| 密码安全 | **Passlib (bcrypt)** | 加密和验证用户密码 |
| 认证 | **python-jose (JWT)** | 创建和验证 JSON Web Token |
| 配置管理 | **pydantic-settings** | 管理 `.env` 中的敏感配置 |
| 服务器 | **Uvicorn** | 高性能 ASGI 服务器 |
| 文件处理 | **python-multipart** | 支持文件上传（图片等） |

---

## 3. 项目架构：关注点分离 (Separation of Concerns)

我们采用模块化架构，将后端分为多个独立职责模块：

| 模块 | 职责描述 |
|------|-----------|
| **main.py**（API 路由层，“服务员”） | 定义所有接口、接收前端请求、验证格式、调用 CRUD |
| **crud.py**（数据库逻辑层，“厨师”） | 封装所有数据库操作（增删改查）与业务逻辑 |
| **models.py**（数据库模型，“仓库蓝图”） | 定义各数据库表结构 |
| **schemas.py**（数据格式定义，“菜单/订单”） | 定义请求/响应格式、数据验证与安全过滤 |
| **security.py**（安全与认证，“保安”） | 密码加密验证、JWT 生成与解码 |
| **database.py / config.py**（配置与连接，“地基/插座”） | 管理环境变量与数据库连接池 |

---

## 4. 核心功能与安全机制

### ✅ 校内邮箱认证
- 在 `crud.create_user` 中强制检查邮箱后缀，确保用户为本校成员。

### 🔐 JWT 身份认证
- `POST /api/token` 登录后签发有效期为约 40 小时的 Access Token。  
- 受保护接口使用 `get_current_user` 依赖项验证 Token。
- Token 在请求头中通过 `Authorization: Bearer <token>` 传递。

### 🧾 帖主授权 (Authorization)
- 在修改/删除帖子时：
  - **认证:** 检查是否已登录。  
  - **授权:** 检查当前用户是否为帖主。  
  ```python
  if db_post.owner_id != current_user.id:
      raise HTTPException(status_code=403, detail="Not authorized")
  ```

### 🖼️ 文件处理与安全上传
- 通过 `uuid.uuid4()` 生成唯一文件名，防止路径攻击。  
- 静态文件目录结构：
  ```
  static/
  ├── images/   # 商品图
  └── avatars/  # 用户头像
  ```
- 仅存储文件 URL 路径于数据库。

### 💬 复杂数据库查询优化
- **收件箱 (Inbox):** 使用 `joinedload` 提前加载用户和帖子信息，并通过 `set()` 去重模拟会话列表。  
- **收藏列表 (Favorites):** 通过 `join` 一次性返回收藏的帖子。
- **消息已读状态:** 通过 `is_read` 字段实现后端驱动的已读跟踪，支持跨设备同步。
- **联系人提取:** 从消息历史中提取与帖子有过私信的用户列表，用于交易确认。

---

## 5. API 接口详单（共 27 个）

> **✅ 公开接口** = 任何人可访问  
> **🔒 受保护接口** = 需提供有效 Token  
> **🔐 授权接口** = 需验证用户权限（如帖主）  

---

### 🔐 认证 (Auth)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/token` | ✅ | 用户登录，返回 Access Token |

---

### 👤 用户 (Users)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/users/register` | ✅ | 注册新用户 |
| `GET` | `/api/users/me` | 🔒 | 获取当前登录用户信息 |
| `PATCH` | `/api/users/me` | 🔒 | 更新用户信息（用户名） |
| `POST` | `/api/users/me/avatar` | 🔒 | 上传/更新头像 |
| `GET` | `/api/users/{user_id}` | ✅ | 查看其他用户公开信息 |

---

### 📦 帖子 (Posts)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/posts` | 🔒 | 发布新帖子 |
| `GET` | `/api/posts` | ✅ | 获取帖子列表（支持分页、筛选、排序、搜索） |
| `GET` | `/api/posts/{id}` | ✅ | 查看帖子详情 |
| `PATCH` | `/api/posts/{id}` | � | 更新自己的帖子 |
| `DELETE` | `/api/posts/{id}` | � | 删除自己的帖子 |
| `GET` | `/api/posts/{id}/contacted-users` | 🔐 | 获取与该帖有过私信的用户列表 |

---

### 🖼️ 图片 (Images)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/posts/{id}/images` | � | 上传商品图片（支持多张） |

---

### 📚 分类 (Categories)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `GET` | `/api/categories` | ✅ | 获取分类列表（用于下拉菜单） |

---

### ⭐ 收藏 (Favorites)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `GET` | `/api/users/me/favorites` | 🔒 | 获取我的收藏列表 |
| `GET` | `/api/posts/{id}/favorite` | 🔒 | 检查是否已收藏该帖子 |
| `POST` | `/api/posts/{id}/favorite` | 🔒 | 收藏帖子 |
| `DELETE` | `/api/posts/{id}/favorite` | 🔒 | 取消收藏 |

---

### ✉️ 私信 (Messages)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/messages` | 🔒 | 发送私信 |
| `GET` | `/api/conversations` | 🔒 | 查看与某人关于某帖的完整聊天记录 |
| `GET` | `/api/users/me/inbox` | 🔒 | 查看收件箱（会话列表+未读计数） |
| `PATCH` | `/api/conversations/mark-read` | 🔒 | 标记指定会话为已读 |

---

### 🚩 举报 (Reports)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/reports` | 🔒 | 举报用户 |

---

### 🤝 交易确认 (Transactions)

| 方法 | 路径 | 权限 | 功能 |
|------|------|------|------|
| `POST` | `/api/transactions` | 🔐 | 创建交易（卖家选择买家） |
| `PATCH` | `/api/transactions/{id}/confirm` | 🔒 | 确认交易（买家或卖家） |
| `GET` | `/api/transactions/my-pending` | 🔒 | 查看待确认的交易列表 |

---

## 6. 数据库设计 (共 8 张表)

| 表名 | 描述 |
|------|------|
| **users** | 用户信息（含校内邮箱、头像、成功交易次数等） |
| **categories** | 分类（教科书、电子产品、日用品等） |
| **posts** | 帖子（核心内容，支持出售/求购/免费三种类型） |
| **post_images** | 商品图片（与帖子一对多） |
| **favorites** | 收藏关系（user_id ↔ post_id） |
| **messages** | 私信记录（sender ↔ receiver ↔ post，含 is_read 字段） |
| **reports** | 举报记录（reporter ↔ reported_user） |
| **transactions** | 交易确认记录（seller ↔ buyer ↔ post，双方确认机制） |

---

## 7. 核心业务逻辑亮点

### 🎯 交易确认系统（双方确认机制）
1. **卖家标记已售出**：选择买家（从与该帖有过私信的用户中选择）
2. **创建交易记录**：生成 Transaction，初始状态双方均未确认
3. **双方独立确认**：买家和卖家分别在"交易"页面点击确认
4. **自动更新信誉**：双方都确认后，各自 `success_trades` 字段 +1
5. **防止重复**：一个帖子只能创建一次交易记录

### 📨 消息已读状态（后端驱动）
- 每条消息有独立的 `is_read` 字段
- 前端通过 `PATCH /api/conversations/mark-read` 标记会话已读
- 支持实时获取未读消息总数，跨设备同步

### 🔍 高级帖子筛选
- 支持按类型（sell/buy/free）、分类、关键词、排序方式组合筛选
- 返回结果包含总数，便于前端实现分页
- 使用 SQLAlchemy 的动态查询构建

---

## 8. 安全与权限控制总览

| 保护级别 | 接口数量 | 说明 |
|---------|---------|------|
| **公开访问** | 8 个 | 注册、登录、浏览帖子、查看分类等 |
| **需要登录** | 19 个 | 发帖、私信、收藏、交易等核心功能 |
| **需要授权** | 6 个 | 编辑/删除自己的帖子、创建交易（帖主）等 |

所有需要身份验证的接口都通过 `Depends(get_current_user)` 依赖项进行保护，确保 Token 的有效性和用户身份的真实性。

---

## 9. 总结

后端开发已全部完成 🎉  

本系统具备以下特性：
- **安全性**：基于 JWT 的认证与细粒度的权限控制  
- **专属性**：校内邮箱验证机制，确保社区纯净度  
- **完整性**：覆盖用户、帖子、消息、收藏、举报、交易确认等所有核心功能  
- **可靠性**：后端驱动的已读状态，双方确认的交易机制  
- **可扩展性**：模块化架构，清晰的关注点分离，支持后期扩展  

**API 覆盖率：100%** - 所有需求文档中的功能均已实现  
系统现已准备好与前端进行 **全面集成与部署**。

````
